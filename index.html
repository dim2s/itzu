<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Testbed Modern Configuration tool </title>
		<!-- jQuery 3.1.1 library -->
		<script src="libs/jquery.min.js"></script>
		<!-- Bootstrap 3.3.7 library -->
		<link rel="stylesheet" href="libs/css/bootstrap.min.css">
		<script src="libs/bootstrap.min.js"></script>
	</head>

	<link rel="stylesheet" type="text/css" href="libs/css/jquery.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/select.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/select.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/buttons.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/rowReorder.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/autoFill.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/chartist.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/active-control.css">

	<body>
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">KitKat</a>
			</div>
			<ul class="nav navbar-nav">
				<li><a href="#">Home</a></li>
				<li><a href="#">Getting started</a></li>
				<li><a href="#">Graph</a></li>
				<li><a href="#">Configuration</a></li>
				<li><a href="#">Contacts</a></li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
				<li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
			</ul>
		</nav>

		<br>

		<div class="modal fade" id="formModal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Modal Header</h4>
					</div>
					<div class="modal-body">
						<!--p>Some text in the modal.</p-->
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					</div>
				</div> <! -- /.modal-content -->
			</div><!-- /.modal-dialog-->
		</div><!-- /.modal -->

		<div class="container-fluid"> 
			<div class="row">
				<div class="col-sm-1"></div>
				<div class="col-sm-10"> 
					<div class="ct-chart ct-golden-section"></div>
				</div>
				<div class="col-sm-1"></div>
			</div>
			<div class="row"> 
				<div class="col-sm-1"></div>
				<div class="col-sm-6">
					<table id="opDataTable" class="display" cellspacing="0" width="100%"> </table>
					<br>
					<div>
						<button type='button' class='btn btn-primary btn-lg' id='saveButton' value='Save' data-toggle='modal' data-target='#formModal'>Save</button>
						<button type='button' class='btn btn-default btn-lg' id='cancelButton' value='Cancel'>Cancel</button>
						<span id='messages'>&nbsp;</span>
					</div>
				</div>
				<div class="col-sm-5">
					<table id="chnDataTable" class="display" cellspacing="0" width="100%"> </table>
				</div>
				<!--div class="col-sm-1"></div-->
			</div>
		</div>

		<!-- datatables-1.10.13 Library -->
		<script type="text/javascript" src="libs/jquery.dataTables.min.js"></script>
		<!-- select 1.2.1 Library -->
		<script type="text/javascript" src="libs/dataTables.select.min.js"></script>
		<!-- Buttons-1.2.4 Library -->
		<script type="text/javascript" src="libs/dataTables.buttons.min.js"></script>
		<!-- Rowreorder-1.2.0 Library -->
		<script type="text/javascript" src="libs/dataTables.rowReorder.min.js"></script>
		<!-- autofill 2.1.3 Library -->
		<script type="text/javascript" src="libs/dataTables.autoFill.min.js"></script>
		<script type="text/javascript" src="client/chnModal.js"></script>
		<script type="text/javascript" src="client/opModal.js"></script>
		<script type="text/javascript" src="client/chnlabellist.js"></script>
		<script src="libs/chartist.min.js"></script>

		<script type="text/javascript">
			/* unordered ToDo list:
			   - select all rows when clicking on the checkbox header
			   - child row with additional info: unit, description, etc..
			   - rendering value column with unit ( unit is a hidden column)
			   - hidden column unit, description, type, targetsRow
			   - ajax implementation for <datalist input>
			   - a2l,puma NN list convertion to json
			   - csv import/export
			   - graphical representation of operating point (D3.js, chartist?)
			   - form validation (required value, range, uniqness)
			   - onreload page confirmation before loosing data
			   - group row by type ( channel tab uniquement )
			   - remplacer yes/no de la colonne ACTIV par une image clickable toggle
			   - limit the number of row datalist can show ( or use JQuery flexdatalist plugin )
			   - use the name of button instead of their indexes ( it can cause some bug if the order is changed )
			   - autocomplete unit, description and type base on label selection
			   - disable remove and edit button when they are not necessary (0 or multi rows selected)
			   - implement local storage feature
			   */
			$(document).ready(function() {

				$('[data-toggle="popover"]').popover();

				var dataSet =[
					{"opId": "1", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"1500", "opEngine":"10", "opTime":"45"} ,
					{"opId": "2", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"1600", "opEngine":"10", "opTime":"45"} ,
					{"opId": "3", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"1700", "opEngine":"10", "opTime":"45"} ,
					{"opId": "4", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"1800", "opEngine":"10", "opTime":"45"} ,
					{"opId": "5", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"1900", "opEngine":"10", "opTime":"45"} ,
					{"opId": "6", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2000", "opEngine":"10", "opTime":"45"} ,
					{"opId": "7", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2100", "opEngine":"10", "opTime":"45"} ,
					{"opId": "8", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2200", "opEngine":"10", "opTime":"45"} ,
					{"opId": "9", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2300", "opEngine":"10", "opTime":"45"} ,
					{"opId": "10", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2400", "opEngine":"10", "opTime":"45"} ,
					{"opId": "11", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2500", "opEngine":"10", "opTime":"45"} ,
					{"opId": "12", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2600", "opEngine":"10", "opTime":"45"} ,
					{"opId": "13", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2700", "opEngine":"10", "opTime":"45"} ,
					{"opId": "14", "opActive": "1", "opMode": "N/C_BRT_5H", "opDyno":"2800", "opEngine":"10", "opTime":"45"}
				];

				//common Datatables properties
				$.extend( true, $.fn.dataTable.defaults, {
					"searching": false,
					"paging": false,
					"info": false,
					"scrollY": "200px",
					"scrollCollapse": true,
					"select" : { 
						style: "multi", 
						selector: 'td:first-child' }
				});

				var t2 = $('#chnDataTable').DataTable({
					columnDefs:[
						{className: 'select-checkbox', targets: 0, width: "10px", defaultContent: ""},
						{
							title:"Label", 
							targets:1, 
							className: "chnLabel", 
							data: "chnLabel", 
							render: function (d,t,r,m) { 
								return "<a href='#' data-toggle='popover' data-placement='bottom' data-container='body' data-content='"+r['chnDesc'] +"'>"+ d + "</a>"  ;}
							},
						{title:"Value",  targets:2, className: "chnValue", data: "chnValue", render: function( d,t,r,m) {return d+" "+r["chnUnit"];} },
						{title:"Trigger", targets:3, className: "chnTrigger", data: "chnTrigger"},
						{title:"Type", targets:4, className : "chnType", data: "chnType" , name: "chnType", visible: false} ,
						{title:"Unit", targets:5, className : "chnUnit", data: "chnUnit", visible: false }, 
						{title:"Desc", targets:6, className : "chnDesc", data: "chnDesc" , visible: false} 

						],
						dom: '<"#chnToolbar">Bfrtip',
					buttons: [ // ** do not change the name attribute **
						{ text:"New", name: "chnNew-btn"},
						{ text:"Remove", name: "chnRemove-btn" },
						{ text:"Edit", name: "chnEdit-btn", state:false},
						{ text:"Merge", name: "chnMerge-btn"},
						{ text: "Import A2L", name: "chnImport-btn"} 
					]	
				});
					
				var t1 = $('#opDataTable').DataTable({
					data: dataSet,
					rowId: "opId",
					"columnDefs":[
						{ orderable: false, targets: '_all'},
						{ className: 'select-checkbox', targets: 0, width: "10px", defaultContent: "" },
						{ title: "State",  targets:7 , data: null,       className:'active-control', defaultContent: "<i></i>" },
						{ title: "#",      targets:1 , data: "opId",     className:'reorder', width: "10px", defaultContent: "" },
						{visible: false , title: "Activ",  targets:6 , data: "opActive",  defaultContent: "1" },
						{ title: "Mode",   targets:2 , data: "opMode" },
						{ title: "Dyno",   targets:3 , data: "opDyno" },
						{ title: "Engine", targets:4 , data: "opEngine"},
						{ title: "Time",   targets:5 , data: "opTime"},
						
					],
					dom: '<"#opToolbar">Bfrtip',
					buttons: [
						{ text: 'New' },
						{ text: 'Remove' },
						{ text: 'Edit' },
						{ text: 'Wizard' },
						{ text: 'Export CSV' },
						{ text: 'Import CSV' }
					],
					autoFill:{
						columns: [3,4,5,6] 
					}	 
				});


				// at the begining there is no row so there is no possibility to 
				// remove, edit or merge a row
				if (t1.rows().count() === 0)
					t1.buttons([1,2,4]).disable();

				t2.buttons([0,1,2,3]).disable();


				// toolbar definition
				$('#opToolbar').html('<h4>Operating points definition</h4>');
				$('#chnToolbar').html('<h4>Channels definition</h4>');

				// make sure that chnDataTable 'new' button is activated only if 
				// one operating point is selected
				function toggleChnDataTable_NewBtn() { 
					if ( t1.rows('.selected').count() > 0 ){
						t2.button(0).enable();
					} else {
						t2.button(0).disable();
					}
				}


				// rules:  
				// 	* you can edit only one item at the time
				//  * you can remove several rows at the same time
			   //   * items should be selected to be edit or remove	
				function toggleDataTable_EditRemoveBtn( dt ) { 
					var count = dt.rows('.selected').count();  
					if ( count === 0 )
						dt.buttons([1,2]).disable();
					if ( count === 1 )
						dt.buttons([1,2]).enable();
					if (count > 1) {
						dt.button(2).disable();
						dt.button(1).enable();
					}
				}

				t1.on( 'select', function (e,dt,type,index) {
					toggleChnDataTable_NewBtn() ;
				} );

				t1.on( 'deselect', function (e,dt,type,index) {
					toggleChnDataTable_NewBtn() ;
				} );

				t1.on( 'select', function (e,dt,type,index) {
					toggleDataTable_EditRemoveBtn(dt) ;
				} );

				t1.on( 'deselect', function (e,dt,type,index) {
					toggleDataTable_EditRemoveBtn(dt) ;
				} );

				t2.on( 'select', function (e,dt,type,index) {
					toggleDataTable_EditRemoveBtn(dt) ;
				} );

				t2.on( 'deselect', function (e,dt,type,index) {
					toggleDataTable_EditRemoveBtn(dt) ;
				} );

				// toggle Activ cell value on click
				$('#opDataTable tbody').on( 'click', 'td.active-control' , function () {

						var tr = $(this).closest('tr');
						var tr_idx = tr.index();
						var d = t1.row(tr_idx).data();

						if ( d["opActive"] === 0 ){
							d["opActive"] = 1;
							tr.removeClass( 'ban');
						}else{
							d["opActive"] = 0;
							tr.addClass( 'ban');
						}

						t1.row(tr_idx).data(d).draw();
				});

				//remove selected row in the t2 table
				t2.button(1).action( function( event, dt, btn, config ) {
					removeRows(event, dt, btn, config);
				});

				t1.button(1).action( function( event, dt, btn, config ) {
					removeRows(event, dt, btn, config);
				});


				function removeRows(event, dt, btn, config) {
					dt.rows('.selected').remove().draw();
					if ( dt.rows().count() === 0)
						dt.buttons([1,2]).disable();
				};

				//type = 'chn' or 'op' 
				//mais est-ce vraiment necessaire puisqu'il s'agit de la meme fenetre
				function rowEditFormCreate(b,str,dt_id) {
					var m=$('#formModal');
					m.find('.modal-footer').append(
						'<button type="button" class="btn btn-primary contextualItems" id="ListModify" data-tableid="' +dt_id+ '" data-btntype="'+b.text()+'">Save</button>'
					//	'<input type="submit" class="btn btn-primary contextualItems" id="btn-newSetvalue" value="Save" form="formNewSetValue">'
					);
					m.find('.modal-title').text(b.text());
					m.find('.modal-body').append(str);

					//initialize the datalist only for chnDataTable
					if ( dt_id === 'chnDataTable' )
						loadChnList();

					return m;
				}

				function editRow(e,dt,button,template) {

					var rowSelected = dt.rows( '.selected' );

					if( rowSelected.count() === 1) {
						var m= rowEditFormCreate(button,template,dt.table().node().id ); 
						console.log(rowSelected.data()[0]);	
						$('#formModal *').filter('.dataTableAutoImport').each( function(i) {
							$(this).val(rowSelected.data()[0][$(this).attr('id')]) ;
						});
					
						m.modal('show'); 
					} else {
						alert( 'something goes wrong! you should not be in this state....' );

					}	

				}

				// define the action for edit a row
				t2.button(2).action( function(event,dt,button,config){
					editRow(event,dt,button,str_chnModal);
				});

				t1.button(2).action( function(event,dt,button,config){
					editRow(event,dt,button,str_opModal);
				});

				// define the action for the 'new row' button of t2 table
				/*TODO:
				    1- frontend user input validation ( using HTML5 feature like 'required' attribute for form' and JQuery form method )
					2- handle submit event when save button is pressed :
						for now I'm not able to catch it using JQuery
						the usage of <input type="submit" make the page reload => data loss
				   */
				t2.button(0).action ( function(event,dt,button, config ) {
					rowEditFormCreate(button,str_chnModal,dt.table().node().id).modal('show');
				});

				t1.button(0).action ( function(event,dt,button, config ) {
					rowEditFormCreate(button,str_opModal,dt.table().node().id).modal('show');
				});

				/*TODO: triggered when a new label is selected
				/*TODO: triggered when a new label is selected
				  		should be use in order to autocomplete the form
				*/
				$(document).on('change', '#chnLabel', function(e) {
						console.log("chocote");
				});

				//clean dynamic element from modal DOM object
				$('#formModal').on('hidden.bs.modal', function(e) {
						$('#formModal .contextualItems').remove();
				});

				//new row, save modal handler
				/* ToDo:
				       -  make this function more dynamiaue by using only the attribute id without the use of a classname
					   - dynamically retrieve the available datatable id ( if possible )
				   */
				$(document).on('click','#ListModify', function(e) {
					//check who triggered the click event
					var button = document.getElementById('ListModify'); 
					var table_id = '#'+button.dataset.tableid;
					var recipient = button.dataset.btntype;
					var allowedBtn = [ 'Edit', 'New'] ;

					//if it's not the chnEdit-btn or chnNew-btn just let a message in console.log but leave
					if( $.inArray(recipient, allowedBtn) === -1 )
				   		return;

					var dt = $(table_id).DataTable();
					var inputObj = {};

					$('#formModal *').filter('.dataTableAutoImport').each( function(i) {
						inputObj[$(this).attr('id')]= $(this).val() ;
					});

					//some times we will add a new row, in other case we will edit the existing row	
					if( recipient === allowedBtn[1] ) {
						dt.row.add(inputObj).draw();
					} else { 
						//we can use indexes as we're supposed to have only on row selected
						//make sure it is always the case other wise it is a bug
						var idx=dt.rows('.selected').indexes();
						dt.row(idx).data(inputObj).draw();
					}

					$('#formModal').modal('hide'); 
				});

				
			}); // function.ready({})

		</script>

		<script>
		  // Initialize a Line chart in the container with the ID chart1
		    new Chartist.Line('.ct-chart', {
		        labels: [1500, 1750, 2000, 2250],
			    series: [[100, 120, 180, 200]]
		    }, { width: '100%', height: '500px'});

		</script>
	</body>
</html>
