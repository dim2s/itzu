<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Testbed Modern Configuration tool </title>
		<!-- jQuery 3.1.1 library -->
		<script src="libs/jquery.min.js"></script>
		<!-- Bootstrap 3.3.7 library -->
		<link rel="stylesheet" href="libs/css/bootstrap.min.css">
		<script src="libs/bootstrap.min.js"></script>
	</head>

	<link rel="stylesheet" type="text/css" href="libs/css/jquery.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/select.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/select.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/buttons.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/rowReorder.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/autoFill.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/active-control.css">
	<link rel="stylesheet" type="text/css" href="libs/css/graph.css">

	<body data-spy="scroll" data-target=".navbar" data-offset="50">
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">Itzu</a>
			</div>
			<ul class="nav navbar-nav">
				<li><a href="#">Getting started</a></li>
				<li><a href="#panel-graph">Graph</a></li>
				<li><a href="#panel-conf">Configuration</a></li>
				<li><a href="#">Contacts</a></li>
			</ul>
			<!--ul class="nav navbar-nav navbar-right">
				<li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
				<li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
			</ul-->
		</nav>

		<br>

		<div class="modal fade" id="formModal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Modal Header</h4>
					</div>
					<div class="modal-body">
						<!--p>Some text in the modal.</p-->
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					</div>
				</div> <! -- /.modal-content -->
			</div><!-- /.modal-dialog-->
		</div><!-- /.modal -->

		<div class="container-fluid"> 
			</br></br></br> <!-- ToDo: replace this kick hack... -->
			<div class="panel panel-default" id="panel-graph" >
				<div class="panel-heading" >
						<h4 class="panel-title">Operating points graphical representation</h4>
				</div>
				<div class="panel-body fixed-panel" >
					<div class="row">
						<div class="col-sm-1"></div>
						<div class="col-sm-11" id="svg-container"> </div>
					</div>
				</div>
			</div>

			<div class="panel panel-default" id="panel-conf">
				<div class="panel-heading" >
					<h4 class="pannel-title">	Operating points configuration </h4>
				</div>
				<div class="panel-body" >
					<div class="row"> 
						<div class="col-sm-1"></div>
						<div class="col-sm-5">
							<table id="opDataTable" class="display" cellspacing="0" width="100%"> </table>
						</div>
						<div class="col-sm-5">
							<table id="chnDataTable" class="display" cellspacing="0" width="100%"> </table>
						</div>
						<div class="col-sm-1"></div>
					</div>
				</div>
			</div> <!--div class="col-sm-1"></div-->

		<!-- datatables-1.10.13 Library -->
		<script type="text/javascript" src="libs/jquery.dataTables.min.js"></script>
		<!-- select 1.2.1 Library -->
		<script type="text/javascript" src="libs/dataTables.select.min.js"></script>
		<!-- Buttons-1.2.4 Library -->
		<script type="text/javascript" src="libs/dataTables.buttons.min.js"></script>
		<script type="text/javascript" src="libs/buttons.html5.min.js"></script>
		<!-- Rowreorder-1.2.0 Library -->
		<script type="text/javascript" src="libs/dataTables.rowReorder.min.js"></script>
		<!-- autofill 2.1.3 Library -->
		<script type="text/javascript" src="libs/dataTables.autoFill.min.js"></script>
		<!-- d3.js 4.7.3 Library -->
		<script type="text/javascript" src="libs/d3.min.js"></script>
		<script type="text/javascript" src="libs/murmurhash2_gc.js"></script>
		<script type="text/javascript" src="client/chnModal.js"></script>
		<script type="text/javascript" src="client/opModal.js"></script>
		<script type="text/javascript" src="client/wizardModal.js"></script>
		<script type="text/javascript" src="client/chnlabellist.js"></script>
		<script type="text/javascript" src="client/chart.js"></script>
		<script type="text/javascript" src="client/wizard.js"></script>
		<script type="text/javascript" src="client/hash.js"></script>
		<script type="text/javascript" src="client/set.js"></script>
		<!--script src="libs/chartist.min.js"></script-->

		<script type="text/javascript">
			/* unordered ToDo list:
			   - child row with additional info: unit, description, etc..
			   - hidden column unit, description, type, targetsRow
			   - a2l,puma NN list convertion to json
			   - csv import/export
			   - form validation (required value, range, uniqness)
			   - onreload page confirmation before loosing data
			   - group row by type ( channel tab uniquement )
			   - limit the number of row datalist can show ( or use JQuery flexdatalist plugin )
			   - use the name of button instead of their indexes ( it can cause some bug if the order is changed )
			   - autocomplete unit, description and type base on label selection
			   - implement local storage feature
			   - when filling form, goes to next input on enter key pressed event
			   - mark select all check box when check

			   */
			$(document).ready(function() {

				$('[data-toggle="popover"]').popover();
				var chart = new Chart;
				var targetMode="N/CBRT_5_H";
				chart.init();

				//common Datatables properties
				$.extend( true, $.fn.dataTable.defaults, {
					"searching": true,
					"paging": false,
					"info": false,
					"scrollY": "600px",
					"scrollCollapse": true,
					"select" : { 
						style: "multi", 
						selector: 'td:first-child' }
				});

				var t2 = $('#chnDataTable').DataTable({
					columnDefs:[
						{className: 'select-checkbox', targets: 0, width: "10px", defaultContent: ""},
						{
							title:"Label", 
							targets:1, 
							className: "chnLabel", 
							data: "chnLabel", 
							render: function (d,t,r,m) { 
								return "<a href='#' data-toggle='popover' data-placement='bottom' data-container='body' data-content='"+r['chnDesc'] +"'>"+ d + "</a>"  ;}
							},
						{title:"Value",  targets:2, className: "chnValue", data: "chnValue", render: function( d,t,r,m) {return d+" "+r["chnUnit"];} },
						{title:"Trigger", targets:3, className: "chnTrigger", data: "chnTrigger"},
						{title:"Type", targets:4, className : "chnType", data: "chnType" , name: "chnType", visible: false} ,
						{title:"Unit", targets:5, className : "chnUnit", data: "chnUnit", visible: false }, 
						{title:"Desc", targets:6, className : "chnDesc", data: "chnDesc" , visible: false} ,
						{title:"Targets", targets:7, className : "chnTargets", data: "chnTargets" , defaultContent: ""} 

						],
						dom: '<"#chnToolbar">Brtip',
					buttons: [ // ** do not change the name attribute **
						{ text:"New", name: "chnNew-btn"},
						{ text:"Remove", name: "chnRemove-btn" },
						{ text:"Edit", name: "chnEdit-btn", state:false},
						{ text:"Merge", name: "chnMerge-btn"},
						{ text:"Merge All", name: "chnMergeAll-btn"},
						{ text: "Import A2L", name: "chnImport-btn"} 
					]	
				});

			// rowReorder seems not to be compatible with select	
				var t1 = $('#opDataTable').DataTable({
					//ajax : {
					//	url :"/opImport.json",
					//	dataSrc: ''
					//},
					rowId: "opId",
					"columnDefs":[
						{ orderable: false, targets: '_all'},
						{ title: "<span id='op-select-all'></span>"     ,  targets:0 , data: null,       className: 'select-checkbox',  width: "10px", defaultContent: "" },
						{ title: "State",  targets:7 , data: null,       className: 'active-control', defaultContent: "<i></i>" },
						{ title: "Id",     targets:9 , data: "opId",     className: 'export', width: "10px", visible: false },
						{ title: "#",      targets:1  , defaultContent: ""},
						{ title: "Activ",  targets:6 , data: "opActive", className: 'exportCSV', visible: true , defaultContent: "1" },
						{ title: "Selected",  targets:8 , data: "opSelected",  visible: true , defaultContent: "0" },
						{ title: "Mode",   targets:2 , data: "opMode" ,  className: 'exportCSV'},
						{ title: "Dyno",   targets:3 , data: "opDyno" ,  className: 'exportCSV',},
						{ title: "Engine", targets:4 , data: "opEngine", className: 'exportCSV'},
						{ title: "Time",   targets:5 , data: "opTime" ,  className: 'exportCSV'},
						
					],
					dom: '<"#opToolbar">Brtip',
					buttons: [
						{ text: 'New' },
						{ text: 'Remove' },
						{ text: 'Edit' },
						{ text: 'Wizard' },
						{ 
							text: 'Export CSV', 
							extend: 'csvHtml5',
							fieldSeparator: ';',
							exportOptions: { columns: '.exportCSV'}
						} ,
						{ text: 'Import CSV' }
					],
					autoFill:{
						columns: [3,4,5,6] 
					}	 
				});

				
				if (t1.rows().count() === 0)
					t1.buttons([1,2]).disable();

				t2.buttons([0,1,2,3]).disable();


				// toolbar definition
				$('#opToolbar').html('<h4>Operating points definition</h4>');
				$('#chnToolbar').html('<h4>Channels definition</h4>');

				// make sure that chnDataTable 'new' button is activated only if 
				// one operating point is selected
				function toggleChnDataTable_NewBtn() { 
					if ( t1.rows('.selected').count() > 0 ){
						t2.button(0).enable();
					} else {
						t2.button(0).disable();
					}
				}


				// rules:  
				// 	* you can edit only one item at the time
				//  * you can remove several rows at the same time
			   //   * items should be selected to be edit or remove	
				function toggleDataTable_EditRemoveBtn( dt ) { 
					var count = dt.rows('.selected').count();  
					if ( count === 0 )
						dt.buttons([1,2]).disable();
					if ( count === 1 )
						dt.buttons([1,2]).enable();
					if (count > 1) {
						dt.button(2).disable();
						dt.button(1).enable();
					}
				}

				function selectRowToDraw(mode) {
						return $('#opDataTable')
										.DataTable()
										.rows( function(idx,d,node) { return (d.opMode == mode) ? true : false ;} )
										.data()
										.toArray();

				}

				t1.on( 'order.dt', function () {
					t1.column(1, { order:'applied'}).nodes().each( function (cell, i) {
									cell.innerHTML = i;
					} );
				} ).draw();
						
				t1.on( 'draw', function (e,dt,type,index) {
					var data = selectRowToDraw(targetMode); 
					chart.draw(data);
				} );

				function toggleNodeSelectActive(idx) {
					var isActive = ( $('circle#' + idx).attr('data-active') == "true");
					$('circle#' + idx).attr('data-active', !isActive );
				}


				function selectHandler( dt, index, action ) {
					var s = (action==="select") ? 1:0;
					toggleChnDataTable_NewBtn() ;
					toggleDataTable_EditRemoveBtn(dt) ;

					//toggle the state of the select column value
					index.forEach( function(i) { 
							dt.cell(i,8).data( s ) ;
						});

					var selectedRows = dt.rows('.selected');
					if (selectedRows.count() > 0 ) {
						targetMode = selectedRows.data()[0].opMode;
						var data = selectRowToDraw(targetMode); 
   
						chart.init( data, targetMode );	
						chart.draw(data);
					}
				}

				t1.on( 'select deselect', function (e,dt,type,index) {
					selectHandler( dt, index, e.type ) 
				} ).draw();

				t2.on( 'select', function (e,dt,type,index) {
					toggleDataTable_EditRemoveBtn(dt) ;
				} );

				t2.on( 'deselect', function (e,dt,type,index) {
					toggleDataTable_EditRemoveBtn(dt) ;
				} );

				//Todo: bugfix when using global select the chart is not refresh
				$('#opDataTable_wrapper').on( 'click' ,'th.select-checkbox',  function () {
						var dt=$('#opDataTable').DataTable();

						// toggle select status for all rows	
						if (dt.rows('.selected').count() > 0) {
							dt.rows().deselect().draw();
						} else { 
							dt.rows().select().draw();
						}

				});
				
				// toggle Activ cell value on click
				$('#opDataTable tbody').on( 'click', 'td.active-control' , function () {
						var tr = $(this).closest('tr');
						var tr_idx = tr.index();
						var d = t1.row(tr_idx).data();

						if ( d["opActive"] === 0 ){
							d["opActive"] = 1;
							tr.removeClass( 'ban');
						}else{
							d["opActive"] = 0;
							tr.addClass( 'ban');
						}

						t1.row(tr_idx).data(d).draw();
				});

				//remove selected row in the t2 table
				t2.button(1).action( function( event, dt, btn, config ) {
					removeRows(event, dt, btn, config);
				});

				t1.button(1).action( function( event, dt, btn, config ) {
					removeRows(event, dt, btn, config);
					toggleDataTable_EditRemoveBtn(dt) ;
				});


				function removeRows(event, dt, btn, config) {
					dt.rows('.selected').remove().draw();
					if ( dt.rows().count() === 0)
						dt.buttons([1,2]).disable();
				};

				//type = 'chn' or 'op' 
				//mais est-ce vraiment necessaire puisqu'il s'agit de la meme fenetre
				function rowEditFormCreate(b,str,dt_id) {
					var m=$('#formModal');
					m.find('.modal-footer').append(
						'<button type="button" class="btn btn-primary contextualItems" id="ListModify" data-tableid="' +dt_id+ '" data-btntype="'+b.text()+'">Save</button>'
					//	'<input type="submit" class="btn btn-primary contextualItems" id="btn-newSetvalue" value="Save" form="formNewSetValue">'
					);
					m.find('.modal-title').text(b.text());
					m.find('.modal-body').append(str);

					//initialize the datalist only for chnDataTable
					if ( dt_id === 'chnDataTable' )
						loadChnList();

					return m;
				}

				function wizardFormCreate(b,str,dt_id) {
					var m = $('#formModal');

					m.find('.contextualItems').remove();
					m.find('.modal-title').text(b.text());
					m.find('.modal-body').append(str);
					m.find('.modal-footer').append(
						'<input type="submit" class="btn btn-primary contextualItems" id="btn-wizard" value="Save" form="form-wizard">'
					);
					return m;
				}

				function editRow(e,dt,button,template) {

					var rowSelected = dt.rows( '.selected' );

					if( rowSelected.count() === 1) {
						var m= rowEditFormCreate(button,template,dt.table().node().id ); 
						console.log(rowSelected.data()[0]);	
						$('#formModal *').filter('.dataTableAutoImport').each( function(i) {
							$(this).val(rowSelected.data()[0][$(this).attr('id')]) ;
						});
					
						m.modal('show'); 
					} else {
						alert( 'something goes wrong! you should not be in this state....' );
					}	
				}

				// define the action for edit a row
				t2.button(2).action( function(event,dt,button,config){
					editRow(event,dt,button,str_chnModal);
				});

				t1.button(2).action( function(event,dt,button,config){
					editRow(event,dt,button,str_opModal);
				});

				t1.button(3).action( function(event, dt, button, config) {
					var m= wizardFormCreate(button,str_wizardModal,dt.table().node().id) 

					m.modal('show');
				});


				// define the action for the 'new row' button of t2 table
				/*TODO:
				    1- frontend user input validation ( using HTML5 feature like 'required' attribute for form' and JQuery form method )
					2- handle submit event when save button is pressed :
						for now I'm not able to catch it using JQuery
						the usage of <input type="submit" make the page reload => data loss
				   */
				t2.button(0).action ( function(event,dt,button, config ) {
					rowEditFormCreate(button,str_chnModal,dt.table().node().id).modal('show');
				});

				t1.button(0).action ( function(event,dt,button, config ) {
					rowEditFormCreate(button,str_opModal,dt.table().node().id).modal('show');
				});

				/*TODO: triggered when a new label is selected
				/*TODO: triggered when a new label is selected
				  		should be use in order to autocomplete the form
				*/
				$(document).on('change', '#chnLabel', function(e) {
						console.log("chocote");
				});

				//clean dynamic element from modal DOM object
				$('#formModal').on('hidden.bs.modal', function(e) {
						$('#formModal .contextualItems').remove();
				});

				//wizard handler
				$(document).on('submit', '#form-wizard', function(e) {
						var rows = [];
						var data = [];
						var m=$('#form-wizard');

						var f = $('#form-wizard').serializeArray().reduce(function(obj,item) {
							obj[item.name] = item.value;
							return obj;
							} , {} );

						e.preventDefault();
						data = wizard.data(f);
						
						rows = data.compute(f.direction);
						
						t1.clear();
						t1.rows.add(rows).draw();
						t1.row(0).select();
						$('#formModal').modal('hide');
				});

				//new row, save modal handler
				/* ToDo:
				       -  make this function more dynamiaue by using only the attribute id without the use of a classname
					   - dynamically retrieve the available datatable id ( if possible )
				   */
				$(document).on('click','#ListModify', function(e) {
					//check who triggered the click event
					var button = document.getElementById('ListModify'); 
					var table_id = '#'+button.dataset.tableid;
					var recipient = button.dataset.btntype;
					var allowedBtn = [ 'Edit', 'New'] ;

					//if it's not the chnEdit-btn or chnNew-btn just let a message in console.log but leave
					if( $.inArray(recipient, allowedBtn) === -1 )
				   		return;

					var dt = $(table_id).DataTable();
					var inputObj = {};

					$('#formModal *').filter('.dataTableAutoImport').each( function(i) {
						inputObj[$(this).attr('id')]= $(this).val() ;
					});
					
					inputObj.source = table_id;	
					// todo:
				    //  *	retrieve the value of the default content automaticaly
				    //  *   defferentiate inputObj op vs chn

					// in any cases during saving operation of 'chnDataTable' form
					// the saved value is applied to the selection of rows in '#opDataTable'
					var set = {};
					if (inputObj.source === '#chnDataTable') {
							set.value = inputObj.chnValue;
							set.targets = new Set ($('#opDataTable').DataTable().rows('.selected').ids().toArray());
					}	

					//some times we will add a new row, in other case we will edit the existing row	
					if( recipient === allowedBtn[1] ) {
						if ( inputObj.source === "#opDataTable" ) { 
						// unfortunately defaultContent is not set by datatable in this case so
						// we should set it manualy 
							inputObj.opId = getNewId();
							inputObj.opActive =  1 ;
							inputObj.opSelected = 0 ;
						}
						if ( inputObj.source === '#chnDataTable' ) {
							inputObj.chnTargets = [];
							inputObj.chnTargets.push(set);
						}
						dt.row.add(inputObj).draw();
					} else { 
						//we can use indexes as we're supposed to have only on row selected
						//make sure it is always the case other wise it is a bug
						var idx=dt.rows('.selected').indexes();
						if ( inputObj.source === "#opDataTable" ) {
							inputObj.opId = dt.row(idx).id();
							inputObj.opActive = dt.row(idx).data().opActive;
							inputObj.opSelected = dt.row(idx).data().opSelected;
						}
						
						// no intersection allowed between the current selection and
						// all other chnTargets
						if ( inputObj.source = '#chnDataTable' ) {
							dt.row(idx).data().chnTargets.forEach( function(obj) {
								obj.targets.purge(set.targets);
							});
							
							inputObj.chnTargets = dt.row(idx).data().chnTargets;
							inputObj.chnTargets.push(set);
						}
						
						dt.row(idx).data(inputObj).draw();
					}

					$('#formModal').modal('hide'); 
				});

				// return an array containing all the values for a given channels and a selection of operating
				// points	
				function getChnValuesFromSelection( idSet , channel ) {

					return channel.opTargets.filter ( function(obj) {
						return (obj.targets.intersection(idSet).size > 0);
					}).map ( function(obj) {
						return obj.value;
					});
				}

				
			}); // function.ready({})

		</script>

	</body>
</html>
