<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Testbed Modern Configuration tool </title>
		<!-- jQuery 3.1.1 library -->
		<script src="libs/jquery.min.js"></script>
		<!-- Bootstrap 3.3.7 library -->
		<link rel="stylesheet" href="libs/css/bootstrap.min.css">
		<script src="libs/bootstrap.min.js"></script>
	</head>

	<link rel="stylesheet" type="text/css" href="libs/css/jquery.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/select.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/select.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/buttons.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/rowReorder.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/autoFill.dataTables.min.css">
	<link rel="stylesheet" type="text/css" href="libs/css/chartist.min.css">

	<body>
		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">KitKat</a>
			</div>
			<ul class="nav navbar-nav">
				<li><a href="#">Home</a></li>
				<li><a href="#">Getting started</a></li>
				<li><a href="#">Graph</a></li>
				<li><a href="#">Configuration</a></li>
				<li><a href="#">Contacts</a></li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
				<li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
			</ul>
		</nav>

		<br>

		<div class="modal fade" id="formModal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Modal Header</h4>
					</div>
					<div class="modal-body">
						<p>Some text in the modal.</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					</div>
				</div> <! -- /.modal-content -->
			</div><!-- /.modal-dialog-->
		</div><!-- /.modal -->

		<div class="container-fluid"> 
			<div class="row">
				<div class="col-sm-1"></div>
				<div class="col-sm-10"> 
					<div class="ct-chart ct-golden-section"></div>
				</div>
				<div class="col-sm-1"></div>
			</div>
			<div class="row"> 
				<div class="col-sm-1"></div>
				<div class="col-sm-6">
					<table id="opDataTable" class="display" cellspacing="0" width="100%"> </table>
					<br>
					<div>
						<button type='button' class='btn btn-primary btn-lg' id='saveButton' value='Save' data-toggle='modal' data-target='#formModal'>Save</button>
						<button type='button' class='btn btn-default btn-lg' id='cancelButton' value='Cancel'>Cancel</button>
						<span id='messages'>&nbsp;</span>
					</div>
				</div>
				<div class="col-sm-5">
					<table id="chnDataTable" class="display" cellspacing="0" width="100%"> </table>
				</div>
				<!--div class="col-sm-1"></div-->
			</div>
		</div>

		<!-- datatables-1.10.13 Library -->
		<script type="text/javascript" src="libs/jquery.dataTables.min.js"></script>
		<!-- select 1.2.1 Library -->
		<script type="text/javascript" src="libs/dataTables.select.min.js"></script>
		<!-- Buttons-1.2.4 Library -->
		<script type="text/javascript" src="libs/dataTables.buttons.min.js"></script>
		<!-- Rowreorder-1.2.0 Library -->
		<script type="text/javascript" src="libs/dataTables.rowReorder.min.js"></script>
		<!-- autofill 2.1.3 Library -->
		<script type="text/javascript" src="libs/dataTables.autoFill.min.js"></script>
		<script type="text/javascript" src="client/setvalue_form.js"></script>
		<script type="text/javascript" src="client/chnlabellist.js"></script>
		<script src="libs/chartist.min.js"></script>

		<script type="text/javascript">
			/* unordered ToDo list:
			   - select all rows when clicking on the checkbox header
			   - child row with additional info: unit, description, etc..
			   - rendering value column with unit ( unit is a hidden column)
			   - hidden column unit, description, type, targetsRow
			   - ajax implementation for <datalist input>
			   - a2l,puma NN list convertion to json
			   - csv import/export
			   - graphical representation of operating point (D3.js, chartist?)
			   - form validation (required value, range, uniqness)
			   - onreload page confirmation before loosing data
			   - group row by type ( channel tab uniquement )
			   - remplacer yes/no de la colonne ACTIV par une image clickable toggle
			   - limit the number of row datalist can show ( or use JQuery flexdatalist plugin )
			   - use the name of button instead of their indexes
			   - autocomplete unit, description and type base on label selection
			   - disable remove and edit button when they are not necessary (0 or multi rows selected)
			   */
			$(document).ready(function() {
				var dataSet =[
					["", "1", "YES", "N/C_BRT_5H","1500", "10", "45", ""] ,
					["", "2", "YES", "N/X","1600", "20", "45", ""] ,
				];

				//common Datatables properties
				$.extend( true, $.fn.dataTable.defaults, {
					"searching": false,
					"paging": false,
					"info": false,
					"scrollY": "200px",
					"scrollCollapse": true,
					"select" : { 
						style: "multi", 
						selector: 'td:first-child' }
				});

				var t2 = $('#chnDataTable').DataTable({
					columnDefs:[
						{className: 'select-checkbox', targets: 0, width: "10px", defaultContent: ""},
						{title:"Label", targets:1, className: "chnLabel", data: "chnLabel"},
						{title:"Value",  targets:2, classNeme: "chnValue", data: "chnValue" },
						{title:"Trigger", targets:3, className: "chnTrigger", data: "chnTrigger"},
						{title:"Type", targets:4, className : "chnType", data: "chnType" , name: "chnType"} 

						],
					dom: 'Bfrtip',
					buttons: [ // ** do not change the name attribute **
						{ text:"New", name: "chnNew-btn"},
						{ text:"Remove", name: "chnRemove-btn" },
						{ text:"Edit", name: "chnEdit-btn", state:false},
						{ text:"Merge", name: "chnMerge-btn"},
						{ text: "Import A2L", name: "chnImport-btn"} 
					]	
				});
					
				var t1 = $('#opDataTable').DataTable({
					data: dataSet,
					"columnDefs":[
						{ orderable: false, targets: '_all'},
						{ className: 'select-checkbox', targets: 0, width: "10px"},
						{ className: 'reorder', title: "#",targets:1, width: "10px" },
						{ title: "Activ", targets:2 , width: "30px" },
						{ title: "Mode", targets:3 ,  },
						{ title: "Dyno", targets:4 ,  },
						{ title: "Engine", targets:5 ,  },
						{ title: "Time", targets:6,  },
						
					],
					dom: 'Bfrtip',
					buttons: [
						{ text: 'New' },
						{ text: 'Remove' },
						{ text: 'Edit' },
						{ text: 'Wizard' },
						{ text: 'Export CSV' },
						{ text: 'Import CSV' }
					],
					autoFill:{
						columns: [3,4,5,6] 
					}	 
				});


				// at the begining there is no row so there is no possibility to 
				// remove, edit or merge a row
				t2.buttons([0,1,2,3]).disable();

				// make sure that chnDataTable 'new' button is activated only if 
				// one operating point is selected
				function toggleChnDataTable_NewBtn() { 
					if ( t1.rows('.selected').count() > 0 ){
						t2.button(0).enable();
					} else {
						t2.button(0).disable();
					}
				}

				// make sure that chnDataTable 'edit' and 'remove' button are activated only if 
				// one channel is selected
				function toggleChnDataTable_EditRemoveBtn() { 
					var count = t2.rows('.selected').count();  
					if ( count === 0 )
						t2.buttons([1,2]).disable();
					if ( count === 1 )
						t2.buttons([1,2]).enable();
					if (count > 1) {
						t2.button(2).disable();
						t2.button(1).enable();
					}
				}

				t1.on( 'select', function (e,dt,type,index) {
					toggleChnDataTable_NewBtn() ;
				} );

				t1.on( 'deselect', function (e,dt,type,index) {
					toggleChnDataTable_NewBtn() ;
				} );

				t2.on( 'select', function (e,dt,type,index) {
					toggleChnDataTable_EditRemoveBtn() ;
				} );

				t2.on( 'deselect', function (e,dt,type,index) {
					toggleChnDataTable_EditRemoveBtn() ;
				} );

				//remove selected row in the t2 table
				t2.button(1).action( function( event, dt, btn, config ) {
					dt.rows('.selected').remove().draw();
					if ( t2.rows().count() === 0)
						t2.buttons([1,2]).disable();

				});

				function chnRowEditFormCreate(m,b) {
					m.find('.modal-footer').append(
						'<button type="button" class="btn btn-primary contextualItems" id="chnListModify" data-id="chn' +b.text() + '-btn">Save</button>'
					//	'<input type="submit" class="btn btn-primary contextualItems" id="btn-newSetvalue" value="Save" form="formNewSetValue">'
					);
					m.find('.modal-title').text(b.text());
					m.find('.modal-body').append(str_setvalueForm );
					loadChnList();
				}

				// define the action for edit a row
				t2.button(2).action( function(event,dt,button,config){
						var m=$('#formModal');
						var rowSelected = dt.rows( '.selected' );

					if( rowSelected.count() === 1) {
						chnRowEditFormCreate(m,button); 
						console.log(rowSelected.data()[0]);	
						$('#formModal *').filter('.chnDataTableAutoImport').each( function(i) {
							$(this).val(rowSelected.data()[0][$(this).attr('id')]) ;
						});
					
						m.modal('show'); 
					} else {
						alert( 'multi row edition is not implemented' );

					}	

				});

				// define the action for the 'new row' button of t2 table
				/*TODO:
				    1- frontend user input validation ( using HTML5 feature like 'required' attribute for form' and JQuery form method )
					2- handle submit event when save button is pressed :
						for now I'm not able to catch it using JQuery
						the usage of <input type="submit" make the page reload => data loss
				   */
				t2.button(0).action ( function(event,dt,button, config ) {
					var m=$('#formModal');
					chnRowEditFormCreate(m,button) 
					m.modal('show') 
				});

				/*TODO: triggered when a new label is selected
				  		should be use in order to autocomplete the form
				*/
				$(document).on('change', '#chnLabel', function(e) {
						console.log("chocote");
				});

				//clean dynamic element from modal DOM object
				$('#formModal').on('hidden.bs.modal', function(e) {
						$('#formModal .contextualItems').remove();
				});

				//new row, save modal handler
				/* ToDo:
				       -  make this function more dynamiaue by using only the attribute id without the use of a classname
				   */
				$(document).on('click','#chnListModify', function(e) {
					//check who triggered the click event
					var button = document.getElementById('chnListModify'); 
					var recipient = button.dataset.id;
					var allowedBtn = [ 'chnEdit-btn', 'chnNew-btn'] ;

					//if it's not the chnEdit-btn or chnNew-btn just let a message in console.log but leave
					if( $.inArray(recipient, allowedBtn) === -1 )
				   		return;

					var dt = $('#chnDataTable').DataTable();
					var inputObj = {};

					$('#formModal *').filter('.chnDataTableAutoImport').each( function(i) {
						inputObj[$(this).attr('id')]= $(this).val() ;
					});

					//some times we will add a new row, in other case we will edit the existing row	
					if( recipient === allowedBtn[1] ) {
						dt.row.add(inputObj).draw();
					} else { 
						//we can use indexes as we're supposed to have only on row selected
						//make sure it is always the case other wise it is a bug
						var idx=dt.rows('.selected').indexes();
						dt.row(idx).data(inputObj).draw();
					}

					$('#formModal').modal('hide'); 
				});

				
			}); // function.ready({})

		</script>

		<script>
		  // Initialize a Line chart in the container with the ID chart1
		    new Chartist.Line('.ct-chart', {
		        labels: [1500, 1750, 2000, 2250],
			    series: [[100, 120, 180, 200]]
		    }, { width: '100%', height: '500px'});

		</script>
	</body>
</html>
